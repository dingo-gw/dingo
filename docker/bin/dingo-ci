#!/bin/bash

# Configuration
DEFAULT_BASE_DIR="/tmp/dingo"

BASE_DIR=${1:-/tmp/dingo}

echo "${BASE_DIR}"

# $BASE_DIR is the path to the directory where all run will be performed.
# $RUN_DIR is a subdirectory of $BASE_DIR for this specific run.
# It is created here
RUN_DIR=$(dingo-ci-directory ${BASE_DIR})


send_email() {
    # Save the exit status immediately
    local status=$?
    
    # Check if EMAIL_CONFIG_PATH is provided
    if [ -n "${EMAIL_CONFIG_PATH}" ]; then
        # Attempt to send the report email
        if ! report_email "${RUN_DIR}" "${status}" "${EMAIL_CONFIG_PATH}"; then
            echo "Error: Failed to send report email" >&2
        fi
    fi
    
    # Exit with the original status
    exit ${status}
}

# Enable error handling
set -e

# A report email will be sent at exit,
# no matter if an error occured or not.
trap send_email EXIT


# creating the virtual env if necessary.
# cloning and installing dingo,
# copying content of examples/toy-npe-model,
# creating training and training_data folders
dingo-ci-setup "${RUN_DIR}"

# printing in the terminal if GPU are detected
# by pytorch
dingo-ci-check-gpu "${RUN_DIR}"

# running toy-npe mode
dingo-ci-toy-npe-model "${RUN_DIR}"


